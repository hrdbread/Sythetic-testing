<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Minimal Frame Counter with Claude</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      font-size: 14px;
      background: #ffffff;
    }
    
    .container {
      max-width: 260px;
    }
    
    h1 {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 20px 0;
      color: #333;
    }
    
    .stats {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .stat-item:last-child {
      margin-bottom: 0;
    }
    
    .stat-label {
      color: #666;
    }
    
    .stat-value {
      font-weight: 600;
      color: #333;
    }
    
    button {
      width: 100%;
      padding: 12px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 10px;
    }
    
    button:hover {
      background: #0d8ce8;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .message {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    
    .message.success {
      background: #e8f5e8;
      color: #2d5a2d;
      border: 1px solid #c3e6c3;
    }
    
    .message.error {
      background: #fee;
      color: #c41e3a;
      border: 1px solid #f5c6cb;
    }
    
    .hidden {
      display: none;
    }
    
    .debug {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      margin-top: 20px;
      font-size: 11px;
      color: #666;
      font-family: monospace;
    }
    
    input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .captured-frame {
      margin-top: 20px;
      padding: 15px;
      background: #f8f8f8;
      border-radius: 6px;
    }
    
    .captured-frame img {
      max-width: 100%;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    .analysis-results {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e8;
      border-radius: 6px;
    }
    
    .analysis-content {
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üñºÔ∏è Frame Counter + Claude</h1>
    
    <div class="stats">
      <div class="stat-item">
        <span class="stat-label">Total Frames:</span>
        <span class="stat-value" id="total-frames">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Selected Frames:</span>
        <span class="stat-value" id="selected-frames">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Captured:</span>
        <span class="stat-value" id="captured-frames">0</span>
      </div>
    </div>
    
    <div id="message-container"></div>
    
    <!-- API Key Section -->
    <div id="api-key-section">
      <input type="password" id="api-key-input" placeholder="Enter Claude API Key">
      <button id="save-api-key-btn" style="background: #28a745;">üíæ Save API Key</button>
    </div>
    
    <button id="refresh-btn">üîÑ Refresh Count</button>
    <button id="capture-btn">üì∏ Capture Selected</button>
    <button id="analyze-btn" class="hidden" style="background: #6f42c1;">ü§ñ Analyze with Claude</button>
    <button id="close-btn" style="background: #dc3545;">‚ùå Close Plugin</button>
    
    <!-- Captured Frame Display -->
    <div id="captured-frame" class="captured-frame hidden">
      <h3 style="margin: 0 0 10px 0; font-size: 14px;">Captured Frame:</h3>
      <img id="frame-image" alt="Captured frame">
      <div id="frame-info" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
    </div>
    
    <!-- Analysis Results -->
    <div id="analysis-results" class="analysis-results hidden">
      <h3 style="margin: 0 0 10px 0; font-size: 14px;">ü§ñ Claude Analysis:</h3>
      <div id="analysis-content" class="analysis-content"></div>
    </div>
    
    <div class="debug">
      <strong>Debug Info:</strong><br>
      Last message: <span id="last-message">none</span><br>
      Message count: <span id="message-count">0</span><br>
      API Key: <span id="api-key-status">not set</span>
    </div>
  </div>

  <script>
    console.log('üé® Minimal plugin UI started (CLEAN VERSION)');

    // Global state
    let messageCount = 0;
    let capturedFrame = null;
    let claudeApiKey = localStorage.getItem('claude-api-key') || '';

    // DOM elements
    let totalFramesEl, selectedFramesEl, capturedFramesEl;
    let messageContainer, lastMessageEl, messageCountEl, apiKeyStatusEl;
    let refreshBtn, captureBtn, analyzeBtn, closeBtn;
    let apiKeySection, apiKeyInput, saveApiKeyBtn;
    let capturedFrameDiv, frameImage, frameInfo;
    let analysisResults, analysisContent;

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìã DOM ready - initializing...');
      
      // Get DOM elements
      totalFramesEl = document.getElementById('total-frames');
      selectedFramesEl = document.getElementById('selected-frames');
      capturedFramesEl = document.getElementById('captured-frames');
      messageContainer = document.getElementById('message-container');
      lastMessageEl = document.getElementById('last-message');
      messageCountEl = document.getElementById('message-count');
      apiKeyStatusEl = document.getElementById('api-key-status');
      
      refreshBtn = document.getElementById('refresh-btn');
      captureBtn = document.getElementById('capture-btn');
      analyzeBtn = document.getElementById('analyze-btn');
      closeBtn = document.getElementById('close-btn');
      
      apiKeySection = document.getElementById('api-key-section');
      apiKeyInput = document.getElementById('api-key-input');
      saveApiKeyBtn = document.getElementById('save-api-key-btn');
      
      capturedFrameDiv = document.getElementById('captured-frame');
      frameImage = document.getElementById('frame-image');
      frameInfo = document.getElementById('frame-info');
      
      analysisResults = document.getElementById('analysis-results');
      analysisContent = document.getElementById('analysis-content');

      // Check if elements exist
      console.log('üîç Elements found:', {
        totalFramesEl: !!totalFramesEl,
        refreshBtn: !!refreshBtn,
        captureBtn: !!captureBtn,
        analyzeBtn: !!analyzeBtn
      });

      // Set up message handler
      window.onmessage = function(event) {
        console.log('üì® Message received:', event.data);
        
        messageCount++;
        if (messageCountEl) messageCountEl.textContent = messageCount;
        
        let msg;
        if (event.data.pluginMessage) {
          msg = event.data.pluginMessage;
        } else {
          msg = event.data;
        }
        
        if (lastMessageEl) lastMessageEl.textContent = msg.type || 'unknown';
        
        handleMessage(msg);
      };

      // Set up button handlers
      if (refreshBtn) {
        refreshBtn.onclick = function() {
          console.log('üîÑ Refresh clicked');
          parent.postMessage({ pluginMessage: { type: 'get-frame-count' } }, '*');
        };
      }

      if (captureBtn) {
        captureBtn.onclick = function() {
          console.log('üì∏ Capture clicked');
          parent.postMessage({ pluginMessage: { type: 'capture-frames' } }, '*');
        };
      }

      if (analyzeBtn) {
        analyzeBtn.onclick = function() {
          console.log('ü§ñ Analyze clicked');
          if (capturedFrame && claudeApiKey) {
            analyzeWithClaude();
          } else {
            showMessage('Need API key and captured frame', 'error');
          }
        };
      }

      if (saveApiKeyBtn) {
        saveApiKeyBtn.onclick = function() {
          console.log('üíæ Save API key clicked');
          const key = apiKeyInput.value.trim();
          if (key) {
            claudeApiKey = key;
            localStorage.setItem('claude-api-key', key);
            showMessage('API key saved!', 'success');
            updateUI();
          }
        };
      }

      if (closeBtn) {
        closeBtn.onclick = function() {
          console.log('‚ùå Close clicked');
          parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
        };
      }

      // Initialize UI state
      updateUI();
      
      // Request initial data
      parent.postMessage({ pluginMessage: { type: 'get-frame-count' } }, '*');
      
      console.log('‚úÖ UI initialized');
    });

    function handleMessage(msg) {
      console.log('üì® Handling message:', msg.type);
      
      switch (msg.type) {
        case 'frame-count':
          if (totalFramesEl) totalFramesEl.textContent = msg.count;
          break;
          
        case 'selection-changed':
          if (selectedFramesEl) selectedFramesEl.textContent = msg.selectedFrames;
          if (captureBtn) captureBtn.disabled = msg.selectedFrames === 0;
          break;
          
        case 'capture-progress':
          showMessage(msg.message, 'success');
          break;
          
        case 'capture-result':
          if (msg.success && msg.frames && msg.frames.length > 0) {
            capturedFrame = msg.frames[0];
            if (capturedFramesEl) capturedFramesEl.textContent = '1';
            displayFrame(capturedFrame);
            showMessage(msg.message, 'success');
          } else {
            showMessage(msg.message, 'error');
          }
          break;
          
        default:
          console.log('Unknown message type:', msg.type);
      }
    }

    function displayFrame(frame) {
      console.log('üñºÔ∏è Displaying frame:', frame.name);
      
      if (frameImage) {
        frameImage.src = frame.image;
        frameImage.alt = frame.name;
      }
      
      if (frameInfo) {
        frameInfo.textContent = `${frame.name} (${frame.width}√ó${frame.height})`;
      }
      
      if (capturedFrameDiv) {
        capturedFrameDiv.classList.remove('hidden');
      }
      
      updateUI();
    }

    function updateUI() {
      // Update API key status
      if (apiKeyStatusEl) {
        apiKeyStatusEl.textContent = claudeApiKey ? 'set' : 'not set';
      }
      
      // Show/hide API key section
      if (apiKeySection) {
        if (claudeApiKey) {
          apiKeySection.classList.add('hidden');
        } else {
          apiKeySection.classList.remove('hidden');
        }
      }
      
      // Show/hide analyze button
      if (analyzeBtn) {
        if (capturedFrame && claudeApiKey) {
          analyzeBtn.classList.remove('hidden');
        } else {
          analyzeBtn.classList.add('hidden');
        }
      }
    }

    function showMessage(text, type) {
      console.log(`üì¢ ${type}: ${text}`);
      
      if (!messageContainer) return;
      
      const messageEl = document.createElement('div');
      messageEl.className = `message ${type}`;
      messageEl.textContent = text;
      
      messageContainer.innerHTML = '';
      messageContainer.appendChild(messageEl);
      
      setTimeout(() => {
        if (messageEl.parentNode) {
          messageEl.parentNode.removeChild(messageEl);
        }
      }, 3000);
    }

    async function analyzeWithClaude() {
      console.log('ü§ñ Starting Claude analysis...');
      
      showMessage('ü§ñ Analyzing with Claude...', 'success');
      
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': claudeApiKey,
            'anthropic-version': '2023-06-01'
          },
          body: JSON.stringify({
            model: 'claude-3-haiku-20240307',
            max_tokens: 1000,
            messages: [{
              role: 'user',
              content: [{
                type: 'text',
                text: 'Please analyze this UI design screenshot. Give me a brief analysis (2-3 sentences) of its usability and visual design.'
              }, {
                type: 'image',
                source: {
                  type: 'base64',
                  media_type: 'image/png',
                  data: capturedFrame.image.replace('data:image/png;base64,', '')
                }
              }]
            }]
          })
        });
        
        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }
        
        const result = await response.json();
        const analysisText = result.content[0].text;
        
        if (analysisContent) {
          analysisContent.textContent = analysisText;
        }
        
        if (analysisResults) {
          analysisResults.classList.remove('hidden');
        }
        
        showMessage('‚úÖ Analysis complete!', 'success');
        
      } catch (error) {
        console.error('‚ùå Analysis error:', error);
        showMessage(`‚ùå Analysis failed: ${error.message}`, 'error');
      }
    }

    console.log('‚úÖ Script loaded');
  </script>
</body>
</html>