<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Minimal Frame Counter with Claude</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      font-size: 14px;
      background: #ffffff;
    }
    
    .container {
      max-width: 260px;
    }
    
    h1 {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 20px 0;
      color: #333;
    }
    
    .stats {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .stat-item:last-child {
      margin-bottom: 0;
    }
    
    .stat-label {
      color: #666;
    }
    
    .stat-value {
      font-weight: 600;
      color: #333;
    }
    
    button {
      width: 100%;
      padding: 12px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 10px;
    }
    
    button:hover {
      background: #0d8ce8;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .message {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    
    .message.success {
      background: #e8f5e8;
      color: #2d5a2d;
      border: 1px solid #c3e6c3;
    }
    
    .message.error {
      background: #fee;
      color: #c41e3a;
      border: 1px solid #f5c6cb;
    }
    
    .hidden {
      display: none;
    }
    
    .debug {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      margin-top: 20px;
      font-size: 11px;
      color: #666;
      font-family: monospace;
    }
    
    input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .captured-frame {
      margin-top: 20px;
      padding: 15px;
      background: #f8f8f8;
      border-radius: 6px;
    }
    
    .captured-frame img {
      max-width: 100%;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    .analysis-results {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e8;
      border-radius: 6px;
    }
    
    .analysis-content {
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üñºÔ∏è Frame Counter + Claude</h1>
    
    <div class="stats">
      <div class="stat-item">
        <span class="stat-label">Total Frames:</span>
        <span class="stat-value" id="total-frames">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Selected Frames:</span>
        <span class="stat-value" id="selected-frames">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Captured:</span>
        <span class="stat-value" id="captured-frames">0</span>
      </div>
    </div>
    
    <div id="message-container"></div>
    
    <!-- API Key Section -->
    <div id="api-key-section">
      <input type="password" id="api-key-input" placeholder="Enter Claude API Key">
      <button id="save-api-key-btn" style="background: #28a745;">üíæ Save API Key</button>
    </div>
    
    <button id="refresh-btn">üîÑ Refresh Count</button>
    <button id="capture-btn">üì∏ Capture Selected</button>
    <button id="analyze-btn" class="hidden" style="background: #6f42c1;">ü§ñ Analyze with Claude</button>
    <button id="close-btn" style="background: #dc3545;">‚ùå Close Plugin</button>
    
    <!-- Captured Frame Display -->
    <div id="captured-frame" class="captured-frame hidden">
      <h3 style="margin: 0 0 10px 0; font-size: 14px;">Captured Frame:</h3>
      <img id="frame-image" alt="Captured frame">
      <div id="frame-info" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
    </div>
    
    <!-- Analysis Results -->
    <div id="analysis-results" class="analysis-results hidden">
      <h3 style="margin: 0 0 10px 0; font-size: 14px;">ü§ñ Claude Analysis:</h3>
      <div id="analysis-content" class="analysis-content"></div>
    </div>
    
    <div class="debug">
      <strong>Debug Info:</strong><br>
      Last message: <span id="last-message">none</span><br>
      Message count: <span id="message-count">0</span><br>
      API Key: <span id="api-key-status">not set</span>
    </div>
  </div>

  <script>
    console.log('üé® Minimal plugin UI started (CLEAN VERSION)');

    // Global error handler
    window.onerror = function(msg, url, line, col, error) {
      console.error('üö® Global error:', { msg, url, line, col, error });
      return false;
    };
    
    window.addEventListener('unhandledrejection', function(event) {
      console.error('üö® Unhandled promise rejection:', event.reason);
    });

    // Global state
    let messageCount = 0;
    let capturedFrame = null;
    let capturedFrames = [];
    let claudeApiKey = '';
    
    // Safe localStorage access
    function getStoredApiKey() {
      try {
        return localStorage.getItem('claude-api-key') || '';
      } catch (e) {
        console.log('üìù localStorage not available, using session storage');
        return '';
      }
    }
    
    function setStoredApiKey(key) {
      try {
        localStorage.setItem('claude-api-key', key);
        return true;
      } catch (e) {
        console.log('üìù localStorage not available, key stored in memory only');
        return false;
      }
    }

    // DOM elements
    let totalFramesEl, selectedFramesEl, capturedFramesEl;
    let messageContainer, lastMessageEl, messageCountEl, apiKeyStatusEl;
    let refreshBtn, captureBtn, analyzeBtn, closeBtn;
    let apiKeySection, apiKeyInput, saveApiKeyBtn;
    let capturedFrameDiv, frameImage, frameInfo;
    let analysisResults, analysisContent;

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      try {
        console.log('üìã DOM ready - initializing...');
      
      // Get DOM elements
      totalFramesEl = document.getElementById('total-frames');
      selectedFramesEl = document.getElementById('selected-frames');
      capturedFramesEl = document.getElementById('captured-frames');
      messageContainer = document.getElementById('message-container');
      lastMessageEl = document.getElementById('last-message');
      messageCountEl = document.getElementById('message-count');
      apiKeyStatusEl = document.getElementById('api-key-status');
      
      refreshBtn = document.getElementById('refresh-btn');
      captureBtn = document.getElementById('capture-btn');
      analyzeBtn = document.getElementById('analyze-btn');
      closeBtn = document.getElementById('close-btn');
      
      apiKeySection = document.getElementById('api-key-section');
      apiKeyInput = document.getElementById('api-key-input');
      saveApiKeyBtn = document.getElementById('save-api-key-btn');
      
      capturedFrameDiv = document.getElementById('captured-frame');
      frameImage = document.getElementById('frame-image');
      frameInfo = document.getElementById('frame-info');
      
      analysisResults = document.getElementById('analysis-results');
      analysisContent = document.getElementById('analysis-content');

      // Check if elements exist
      console.log('üîç Elements found:', {
        totalFramesEl: !!totalFramesEl,
        refreshBtn: !!refreshBtn,
        captureBtn: !!captureBtn,
        analyzeBtn: !!analyzeBtn
      });

      // Set up message handler
      window.onmessage = function(event) {
        try {
          console.log('üì® Message received:', event.data);
          console.log('üì® Event source:', event.source);
          console.log('üì® Event origin:', event.origin);
          
          messageCount++;
          if (messageCountEl) messageCountEl.textContent = messageCount;
          
          let msg;
          if (event.data.pluginMessage) {
            console.log('üì¶ Using pluginMessage format');
            msg = event.data.pluginMessage;
          } else {
            console.log('üì¶ Using direct format');
            msg = event.data;
          }
          
          console.log('üì® Final message:', msg);
          if (lastMessageEl) lastMessageEl.textContent = msg.type || 'unknown';
          
          handleMessage(msg);
        } catch (error) {
          console.error('‚ùå Error in message handler:', error);
        }
      };

      // Set up button handlers
      if (refreshBtn) {
        refreshBtn.onclick = function() {
          console.log('üîÑ Refresh clicked');
          parent.postMessage({ pluginMessage: { type: 'get-frame-count' } }, '*');
        };
      }

      if (captureBtn) {
        captureBtn.onclick = function() {
          console.log('üì∏ Capture clicked');
          parent.postMessage({ pluginMessage: { type: 'capture-frames' } }, '*');
        };
      }

      if (analyzeBtn) {
        analyzeBtn.onclick = function() {
          console.log('ü§ñ Analyze clicked');
          if (capturedFrame && claudeApiKey) {
            // Send analysis request to main thread (which has network access)
            parent.postMessage({ 
              pluginMessage: { 
                type: 'analyze-with-claude',
                apiKey: claudeApiKey,
                frame: capturedFrame
              } 
            }, '*');
            showMessage('ü§ñ Sending to Claude...', 'success');
          } else {
            showMessage('Need API key and captured frame', 'error');
          }
        };
      }

      if (saveApiKeyBtn) {
        saveApiKeyBtn.onclick = function() {
          console.log('üíæ Save API key clicked');
          const key = apiKeyInput.value.trim();
          if (key) {
            claudeApiKey = key;
            setStoredApiKey(key);
            showMessage('API key saved!', 'success');
            updateUI();
          }
        };
      }

      if (closeBtn) {
        closeBtn.onclick = function() {
          console.log('‚ùå Close clicked');
          parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
        };
      }

      // Initialize stored API key
      claudeApiKey = getStoredApiKey();
      
      // Initialize UI state
      updateUI();
      
      // Request initial data
      parent.postMessage({ pluginMessage: { type: 'get-frame-count' } }, '*');
      
      console.log('‚úÖ UI initialized');
      } catch (error) {
        console.error('‚ùå Error during DOM initialization:', error);
      }
    });

    function handleMessage(msg) {
      console.log('üì® Handling message:', msg.type);
      
      switch (msg.type) {
        case 'frame-count':
          if (totalFramesEl) totalFramesEl.textContent = msg.count;
          break;
          
        case 'selection-changed':
          if (selectedFramesEl) selectedFramesEl.textContent = msg.selectedFrames;
          if (captureBtn) captureBtn.disabled = msg.selectedFrames === 0;
          break;
          
        case 'capture-progress':
          showMessage(msg.message, 'success');
          break;
          
        case 'analysis-progress':
          showMessage(msg.message, 'success');
          break;
          
        case 'analysis-result':
          if (msg.success) {
            if (analysisContent) {
              analysisContent.textContent = msg.analysis;
            }
            if (analysisResults) {
              analysisResults.classList.remove('hidden');
            }
            if (msg.isMock) {
              showMessage('‚úÖ Mock analysis complete! (CORS prevented real API call)', 'success');
            } else {
              showMessage('‚úÖ Claude analysis complete!', 'success');
            }
          } else {
            showMessage(`‚ùå Analysis failed: ${msg.error}`, 'error');
          }
          break;
          
        case 'capture-result':
          if (msg.success && msg.frames && msg.frames.length > 0) {
            // Store all captured frames but display the first one for Claude analysis
            capturedFrame = msg.frames[0];
            capturedFrames = msg.frames;
            
            if (capturedFramesEl) capturedFramesEl.textContent = msg.frames.length;
            displayFrame(capturedFrame, msg.frames.length);
            showMessage(msg.message, 'success');
          } else {
            showMessage(msg.message, 'error');
          }
          break;
          
        default:
          console.log('Unknown message type:', msg.type);
      }
    }

    function displayFrame(frame, totalCount = 1) {
      console.log('üñºÔ∏è Displaying frame:', frame.name, `(1 of ${totalCount})`);
      
      if (frameImage) {
        frameImage.src = frame.image;
        frameImage.alt = frame.name;
      }
      
      if (frameInfo) {
        if (totalCount > 1) {
          frameInfo.textContent = `${frame.name} (${frame.width}√ó${frame.height}) - Showing 1 of ${totalCount} captured frames`;
        } else {
          frameInfo.textContent = `${frame.name} (${frame.width}√ó${frame.height})`;
        }
      }
      
      if (capturedFrameDiv) {
        capturedFrameDiv.classList.remove('hidden');
      }
      
      updateUI();
    }

    function updateUI() {
      // Update API key status
      if (apiKeyStatusEl) {
        apiKeyStatusEl.textContent = claudeApiKey ? 'set' : 'not set';
      }
      
      // Show/hide API key section
      if (apiKeySection) {
        if (claudeApiKey) {
          apiKeySection.classList.add('hidden');
        } else {
          apiKeySection.classList.remove('hidden');
        }
      }
      
      // Show/hide analyze button
      if (analyzeBtn) {
        if (capturedFrame && claudeApiKey) {
          analyzeBtn.classList.remove('hidden');
        } else {
          analyzeBtn.classList.add('hidden');
        }
      }
    }

    function showMessage(text, type) {
      console.log(`üì¢ ${type}: ${text}`);
      
      if (!messageContainer) return;
      
      const messageEl = document.createElement('div');
      messageEl.className = `message ${type}`;
      messageEl.textContent = text;
      
      messageContainer.innerHTML = '';
      messageContainer.appendChild(messageEl);
      
      setTimeout(() => {
        if (messageEl.parentNode) {
          messageEl.parentNode.removeChild(messageEl);
        }
      }, 3000);
    }


    console.log('‚úÖ Script loaded');
  </script>
</body>
</html>